# üîê Autentica√ß√£o e Seguran√ßa - NewsGrid

Este documento descreve o funcionamento do sistema de autentica√ß√£o via **JWT Bearer Token** implementado no NewsGrid.

## üß† Arquitetura

O sistema utiliza o padr√£o **OAuth2 com JWT Bearer Token**, seguindo as melhores pr√°ticas do FastAPI. Ap√≥s o login, um token JWT √© gerado e deve ser enviado no header `Authorization` de todas as requisi√ß√µes protegidas.

### Fluxo de Valida√ß√£o
1. **Cliente** faz login enviando `username` e `password` (token de acesso) via POST para `/api/v1/auth/login`.
2. **API (FastAPI)** valida o token de acesso no Redis, verifica se pertence ao usu√°rio e gera um JWT.
3. **Para rotas protegidas:** A API valida o JWT via depend√™ncia `get_current_user` usando `OAuth2PasswordBearer`.
4. **Se V√°lido:** O JWT √© decodificado e o `username` √© extra√≠do do payload. A API permite o acesso.
5. **Se Inv√°lido:** A API retorna `401 Unauthorized` com header `WWW-Authenticate: Bearer`.

### Vantagens do JWT
- **Stateless:** N√£o requer consulta ao Redis para validar sess√µes.
- **Padr√£o de Mercado:** Compat√≠vel com qualquer cliente HTTP e frameworks frontend.
- **Swagger UI:** Integra√ß√£o nativa com o bot√£o "Authorize" em `/docs`.

---

## üöÄ Como Usar

### 1. Credenciais Iniciais (Seed)
Para inicializar o sistema com um usu√°rio administrador, execute o script de seed:

```bash
make seed
# ou
uv run python -m scripts.seed_initial
```

Isso cria o usu√°rio padr√£o no Redis se ele n√£o existir.

* **Usu√°rio Padr√£o:** `admin`
* **Token de Acesso Padr√£o:** `12345678-1234-5678-9012-123456789012` (Configur√°vel via `settings.default_token` pelo `.env`)

### 2. Processo de Autentica√ß√£o
1. **Login:** Envie uma requisi√ß√£o POST para `/api/v1/auth/login` com `username` e `password` (seu token de acesso).
2. **Receba o JWT:** A resposta cont√©m `access_token` e `token_type`.
3. **Use o JWT:** Inclua o header `Authorization: Bearer <access_token>` em todas as requisi√ß√µes protegidas.

---

## üì° Endpoints de Autentica√ß√£o

### Login

**POST** `/api/v1/auth/login`

**Content-Type:** `application/x-www-form-urlencoded` (padr√£o OAuth2)

**Form Data:**

| Campo | Descri√ß√£o |
|-------|-----------|
| `username` | Nome do usu√°rio |
| `password` | Token de acesso do usu√°rio |

**Resposta de Sucesso:**

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

### Expira√ß√£o do Token

- **Expira√ß√£o:** O JWT expira ap√≥s 30 minutos (configur√°vel via `jwt_access_token_expire_minutes`).
- **Relat√≥rios:** Relat√≥rios criados permanecem associados ao usu√°rio no Redis e podem ser acessados ap√≥s novo login.
- **Renova√ß√£o:** Para renovar o acesso, o usu√°rio deve fazer login novamente via `/api/v1/auth/login`.

### Verificar Usu√°rio Atual

**GET** `/api/v1/auth/me`

**Header:** `Authorization: Bearer <access_token>`

**Resposta:**

```json
{
  "username": "admin",
  "status": "authenticated via JWT"
}
```

### Criar Novo Usu√°rio

**POST** `/api/v1/users/`

*Requer JWT v√°lido no header Authorization.*

**Body:**

```json
{
  "username": "parceiro11",
  "token": "123e4567-e89b-12d3-a456-426614174000"
}
```

> O campo `token` √© opcional. Se omitido, ser√° gerado automaticamente um UUID.

### Listar Usu√°rios

**GET** `/api/v1/users/`

*Requer JWT v√°lido.*

Retorna todos os usu√°rios cadastrados no sistema.

### Revogar Acesso

**DELETE** `/api/v1/users/{username}`

*Requer JWT v√°lido.*

Remove imediatamente o acesso do usu√°rio, invalidando o token de acesso.

---

## üõ°Ô∏è Estrutura no Redis

Para manter a organiza√ß√£o, utilizamos *Namespacing* nas chaves do Redis:

| Tipo | Padr√£o da Chave | Exemplo | Descri√ß√£o |
| --- | --- | --- | --- |
| **Token** | `auth:token:{token}` | `auth:token:abc-123` | Guarda o `username` dono do token de acesso. |
| **Usu√°rio** | `auth:user:{username}` | `auth:user:admin` | Guarda o `token` atual do usu√°rio (lookup reverso). |
| **Lista** | `auth:users_list` | `auth:users_list` | Set contendo todos os usernames ativos. |
| **Relat√≥rios** | `user:{username}:reports` | `user:admin:reports` | Set contendo IDs dos relat√≥rios gerados pelo usu√°rio. |

> **Nota:** Com JWT, n√£o h√° mais chaves `session:{session_id}` no Redis. A valida√ß√£o √© feita via assinatura do token.

---

## ‚öôÔ∏è Configura√ß√£o JWT

As seguintes vari√°veis de ambiente controlam o comportamento do JWT (definidas em `utils/settings.py`):

| Vari√°vel | Padr√£o | Descri√ß√£o |
|----------|--------|-----------|
| `JWT_SECRET_KEY` | `sua-chave-secreta-super-segura` | Chave secreta para assinar os tokens |
| `JWT_ALGORITHM` | `HS256` | Algoritmo de assinatura |
| `JWT_ACCESS_TOKEN_EXPIRE_MINUTES` | `30` | Tempo de expira√ß√£o do token em minutos |

> ‚ö†Ô∏è **Importante:** Em produ√ß√£o, defina `JWT_SECRET_KEY` com uma chave forte e √∫nica no arquivo `.env`.

---

## üîÑ Fluxo de Processamento (Worker)

1. O usu√°rio autenticado solicita uma an√°lise (com JWT no header).
2. A API extrai o `username` do JWT e anexa ao payload da mensagem enviada ao RabbitMQ.
3. O Worker processa a IA.
4. O Worker salva o relat√≥rio final e usa o `ReportService` para vincular esse relat√≥rio √† lista do usu√°rio (`user:{username}:reports`).

Isso garante que cada usu√°rio tenha acesso apenas aos seus pr√≥prios relat√≥rios.

---

## üìã Exemplos Pr√°ticos

### Usando cURL (Terminal)

#### 1. Fazer Login

```bash
curl -X POST "http://localhost:8000/api/v1/auth/login" \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -d "username=admin&password=12345678-1234-5678-9012-123456789012"
```

**Resposta:**

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

#### 2. Fazer uma Requisi√ß√£o Protegida (usando o JWT)

```bash
curl -X POST "http://localhost:8000/api/v1/analyze/?topic=Inteligencia%20Artificial" \
     -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

#### 3. Verificar Usu√°rio Logado

```bash
curl -X GET "http://localhost:8000/api/v1/auth/me" \
     -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

### Usando Swagger UI

1. Acesse `http://localhost:8000/docs`
2. Clique no bot√£o **Authorize** üîì no canto superior direito
3. Preencha:
   - **username:** seu nome de usu√°rio (ex: `admin`)
   - **password:** seu token de acesso (ex: `12345678-1234-5678-9012-123456789012`)
4. Clique em **Authorize**
5. Todas as requisi√ß√µes subsequentes incluir√£o automaticamente o JWT

### Usando Python (requests)

```python
import requests

# Login
response = requests.post(
    "http://localhost:8000/api/v1/auth/login",
    data={"username": "admin", "password": "12345678-1234-5678-9012-123456789012"}
)
token = response.json()["access_token"]

# Requisi√ß√£o autenticada
headers = {"Authorization": f"Bearer {token}"}
me = requests.get("http://localhost:8000/api/v1/auth/me", headers=headers)
print(me.json())
```