# üîê Autentica√ß√£o e Seguran√ßa - NewsGrid

Este documento descreve o funcionamento do sistema de autentica√ß√£o via Token implementado no NewsGrid, utilizando Redis como fonte de verdade.

## üß† Arquitetura

O sistema utiliza uma estrat√©gia de **API Key no Header**. N√£o h√° sess√µes ou cookies; cada requisi√ß√£o deve ser autenticada individualmente.

### Fluxo de Valida√ß√£o
1.  **Cliente** envia uma requisi√ß√£o com o header `Authorization: Bearer <token>`.
2.  **API (FastAPI)** intercepta a requisi√ß√£o via depend√™ncia `verify_token`.
3.  **Redis** √© consultado na chave `auth:token:{token_recebido}`.
4.  **Se V√°lido:** O Redis retorna o `username` associado. A API permite o acesso e injeta o usu√°rio no contexto.
5.  **Se Inv√°lido:** A API retorna `401 Unauthorized` ou `403 Forbidden`.

---

## üöÄ Como Usar

### 1. Credenciais Iniciais (Seed)
Ao iniciar a aplica√ß√£o pela primeira vez, o sistema cria automaticamente um usu√°rio administrador se ele n√£o existir.

* **Usu√°rio Padr√£o:** `admin`
* **Token Padr√£o:** `newsgrid-secret-123` (Configur√°vel via c√≥digo/env)

### 2. Cabe√ßalho Obrigat√≥rio
Todas as rotas protegidas exigem o seguinte cabe√ßalho HTTP:

```http
Authorization: Bearer <SEU_TOKEN_AQUI>
```

---

## üì° Endpoints de Autentica√ß√£o

### Criar Novo Usu√°rio

**POST** `/api/v1/auth/create`
*Requer token de um usu√°rio existente (ou do admin).*

**Body:**

```json
{
  "username": "parceiro11",
  "token": "token-personalizado-123" // Opcional (gera UUID se omitido)
}
```

### Listar Usu√°rios

**GET** `/api/v1/auth/list`
*Retorna todos os usu√°rios cadastrados no sistema.*

### Revogar Acesso

**DELETE** `/api/v1/auth/revoke/{username}`
*Remove imediatamente o acesso do usu√°rio, invalidando o token.*

---

## üõ°Ô∏è Estrutura no Redis

Para manter a organiza√ß√£o, utilizamos *Namespacing* nas chaves do Redis:

| Tipo | Padr√£o da Chave | Exemplo | Descri√ß√£o |
| --- | --- | --- | --- |
| **Token** | `auth:token:{token}` | `auth:token:abc-123` | Guarda o `username` dono do token. |
| **Usu√°rio** | `auth:user:{username}` | `auth:user:admin` | Guarda o `token` atual do usu√°rio (lookup reverso). |
| **Lista** | `auth:users_list` | `auth:users_list` | Set contendo todos os usernames ativos. |
| **Relat√≥rios** | `user:{username}:reports` | `user:admin:reports` | Set contendo IDs dos relat√≥rios gerados pelo usu√°rio. |

---

## üîÑ Fluxo de Processamento (Worker)

1. O usu√°rio autenticado solicita uma an√°lise.
2. A API anexa o `user_id` (username) no payload da mensagem e envia para o RabbitMQ.
3. O Worker processa a IA.
4. O Worker salva o relat√≥rio final e usa o `ReportService` para vincular esse relat√≥rio √† lista do usu√°rio (`user:{username}:reports`).

Isso garante que cada usu√°rio tenha acesso apenas/historicamente aos seus pr√≥prios relat√≥rios.

---

### 2. Como fazer a requisi√ß√£o agora (Exemplos Pr√°ticos)

Como agora a porta est√° trancada, voc√™ precisa passar a chave (`Authorization: Bearer <token>`) em toda chamada.

#### Usando cURL (Terminal)

```bash
curl -X POST "http://localhost:8000/api/v1/analyze/?topic=Inteligencia%20Artificial" \
     -H "accept: application/json" \
     -H "Authorization: Bearer newsgrid-secret-123" \
     -d ""
```