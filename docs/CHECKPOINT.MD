## VisÃ£o Geral

O projeto NewsGrid demonstra uma **boa aderÃªncia Ã  Clean Architecture** com separaÃ§Ã£o clara entre camadas (domain, infrastructure, api) e uso de interfaces abstratas (ABCs) para repositÃ³rios. No entanto, existem **violaÃ§Ãµes pontuais da regra de dependÃªncia** e **inconsistÃªncias** que comprometem a pureza arquitetural, especialmente na camada de domÃ­nio e nos controllers. A estrutura estÃ¡ bem organizada para uma POC, mas precisa de refinamentos para produÃ§Ã£o.

---

## 1. Problemas Encontrados

### 1.1 Camadas e Responsabilidades

| Problema | LocalizaÃ§Ã£o | Severidade |
|----------|-------------|------------|
| **Controllers com lÃ³gica de negÃ³cio** | app/api/report/controller.py | ğŸ”´ Alta |
| **Services legados ainda existem** | app/services/ (fora da estrutura DDD) | ğŸŸ¡ MÃ©dia |

**Exemplo do problema em controller.py:**

```python
def request_analysis_logic(topic: str, user_id: int):
    # âŒ LÃ³gica de negÃ³cio direta no controller
    cache_key = make_cache_key(topic)
    cached_report = get_cached_report(cache_key)
    if cached_report:
        return {"status": "cached", "report": cached_report}

    task_id = str(uuid.uuid4())
    task_status_service.set_researching(task_id)  # âŒ Chamada direta a service

    payload = {"task_id": task_id, "topic": topic, "user_id": str(user_id)}
    send_to_queue("queue_research", payload)  # âŒ Infraestrutura no controller
```

**vs. o correto em controller.py:**

```python
def request_analysis_logic(request: AnalyzeRequest, user_id: int) -> AnalyzeResponse:
    use_case = container.request_analysis_use_case()  # âœ… Usa Use Case
    result = use_case.execute(request.topic, user_id)
    return AnalyzeResponse(**result)
```

---

### 1.2 Regra de DependÃªncia

| ViolaÃ§Ã£o | Arquivo | DescriÃ§Ã£o |
|----------|---------|-----------|
| **Use Case depende de funÃ§Ã£o de infraestrutura** | use_cases.py | `send_to_queue` importado diretamente |
| **Entidade com import de exception utilitÃ¡ria** | - | Deveria ter exceÃ§Ãµes prÃ³prias do domÃ­nio |

**Exemplo crÃ­tico:**

```python
from utils.send_to_queue import send_to_queue  # âŒ VIOLAÃ‡ÃƒO: domÃ­nio importa infraestrutura

class RequestAnalysisUseCase:
    def execute(self, topic: str, user_id: int) -> dict[str, Any]:
        # ...
        try:
            send_to_queue("queue_research", payload)  # âŒ Chamada direta
```

---

### 1.3 DomÃ­nio e Casos de Uso

| Problema | Impacto |
|----------|---------|
| **Entidades usam `dataclass` simples** | Falta validaÃ§Ã£o rica no domÃ­nio |
| **ExceÃ§Ãµes genÃ©ricas** (`BadRequestError`) | Mistura erros HTTP com domÃ­nio |
| **Use Cases retornam `dict`** | Perda de tipagem forte |

**Exemplo de entidade anÃªmica:**

```python
@dataclass
class ReportEntity:
    id: int | None
    task_id: str
    owner_id: int
    topic: str
    content: str | None
    created_at: datetime

    def validate(self):  # âš ï¸ ValidaÃ§Ã£o bÃ¡sica, sem comportamento de negÃ³cio
        if not self.task_id:
            raise ValueError("Task ID Ã© obrigatÃ³rio")
```

---

### 1.4 Interface Adapters e Infraestrutura

| Problema | Arquivo |
|----------|---------|
| **Schema com mÃ©todo `from_entity`** | Acoplamento correto âœ… |
| **Controller instancia Container diretamente** | Deveria receber via DI |
| **Duas pastas `api/analyze` e `api/report` fazem a mesma coisa** | DuplicaÃ§Ã£o |

---

### 1.5 InjeÃ§Ã£o de DependÃªncias

```python
container = Container()  # âŒ InstÃ¢ncia global no mÃ³dulo

def request_analysis_logic(request: AnalyzeRequest, user_id: int):
    use_case = container.request_analysis_use_case()  # âŒ Resolve dentro da funÃ§Ã£o
```

**Problema:** O container Ã© criado como variÃ¡vel de mÃ³dulo, nÃ£o injetado via FastAPI `Depends`.

---

### 1.6 Testabilidade

| Aspecto | Status |
|---------|--------|
| **Use Cases testÃ¡veis isoladamente** | âœ… Sim (recebem interfaces) |
| **Workers acoplados a pika** | âŒ DifÃ­cil mockar |
| **`send_to_queue` hardcoded em Use Case** | âŒ Impede testes puros |

---

## 2. Plano de AÃ§Ã£o (Ordem de Prioridade)

### Fase 1: CorreÃ§Ãµes CrÃ­ticas (1 semana)

#### 1.1 Extrair `send_to_queue` para interface no domÃ­nio

```python
from abc import ABC, abstractmethod
from typing import Any

class IMessageBroker(ABC):
    """Interface para envio de mensagens."""
    
    @abstractmethod
    def publish(self, queue: str, payload: dict[str, Any]) -> None:
        pass
```

```python
from app.domain.messaging.repositories import IMessageBroker
from utils.send_to_queue import send_to_queue

class RabbitMQBroker(IMessageBroker):
    def publish(self, queue: str, payload: dict[str, Any]) -> None:
        send_to_queue(queue, payload)
```

```python
# ANTES:
from utils.send_to_queue import send_to_queue

# DEPOIS:
from app.domain.messaging.repositories import IMessageBroker

class RequestAnalysisUseCase:
    def __init__(
        self,
        cache_repo: ICacheRepository,
        task_status_repo: ITaskStatusRepository,
        message_broker: IMessageBroker,  # âœ… Injetado
    ):
        self.message_broker = message_broker
    
    def execute(self, topic: str, user_id: int) -> dict[str, Any]:
        # ...
        self.message_broker.publish("queue_research", payload)  # âœ… Usa interface
```

#### 1.2 Remover pasta duplicada `api/analyze`

Consolidar em `api/report` que jÃ¡ usa Use Cases corretamente.

---

### Fase 2: Melhoria de DomÃ­nio (2 semanas)

#### 2.1 Criar exceÃ§Ãµes de domÃ­nio

```python
class DomainException(Exception):
    """Base para exceÃ§Ãµes de domÃ­nio."""
    pass

class ReportNotFoundError(DomainException):
    def __init__(self, task_id: str):
        super().__init__(f"RelatÃ³rio nÃ£o encontrado: {task_id}")

class UnauthorizedAccessError(DomainException):
    def __init__(self, resource: str):
        super().__init__(f"Acesso negado a: {resource}")

class RateLimitExceededError(DomainException):
    def __init__(self, reset_in: int):
        super().__init__(f"Limite excedido. Reset em {reset_in}s")
```

#### 2.2 Use Cases retornarem entidades ou DTOs tipados

```python
from dataclasses import dataclass

@dataclass
class AnalysisResult:
    status: str
    task_id: str | None = None
    report: ReportEntity | None = None

class RequestAnalysisUseCase:
    def execute(self, topic: str, user_id: int) -> AnalysisResult:  # âœ… Tipo forte
        # ...
        return AnalysisResult(status="processing", task_id=task_id)
```

---

### Fase 3: InjeÃ§Ã£o de DependÃªncias via FastAPI (1 semana)

#### 3.1 Criar providers no dependencies.py

```python
from app.core.container import Container

_container = Container()

def get_request_analysis_use_case():
    return _container.request_analysis_use_case()

def get_report_use_case():
    return _container.get_report_use_case()
```

#### 3.2 Usar `Depends` nas rotas

```python
from app.api.dependencies import get_request_analysis_use_case
from app.domain.report.use_cases import RequestAnalysisUseCase

@router.post("/", response_model=AnalyzeResponse)
async def request_analysis(
    request: AnalyzeRequest,
    current_user: get_current_user_dep,
    use_case: RequestAnalysisUseCase = Depends(get_request_analysis_use_case),  # âœ…
):
    result = use_case.execute(request.topic, current_user.id)
    return AnalyzeResponse.from_result(result)
```

---

### Fase 4: Limpeza de Legados (1 semana)

1. **Remover** app/services/ - migrar funcionalidades restantes para Use Cases
2. **Mover** send_to_queue.py para `app/infrastructure/messaging/`
3. **Consolidar** exceÃ§Ãµes em `app/domain/exceptions.py`

---

## 3. Resumo Visual da Arquitetura Atual vs. Ideal

### Atual (com problemas)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Layer (FastAPI)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ routes.py   â”‚â”€â”€â”€â–¶â”‚ controller  â”‚â”€â”€â”                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Domain Layer                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚ use_cases   â”‚â”€â”€â”€â–¶ send_to_queue() âŒ VIOLA REGRA    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ideal (corrigido)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Layer (FastAPI)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ routes.py   â”‚â”€â”€â”€â–¶â”‚ Depends(UC) â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Domain Layer                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ use_cases   â”‚â”€â”€â”€â–¶â”‚ IMessageBroker  â”‚ (interface)     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â–²
                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Infrastructure Layer                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚ RabbitMQBroker      â”‚ (implementa IMessageBroker)    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Checklist de Conformidade

| CritÃ©rio | Status | AÃ§Ã£o |
|----------|--------|------|
| Entidades sem dependÃªncias externas | âš ï¸ | Remover `BadRequestError` |
| Use Cases usam apenas interfaces | âŒ | Criar `IMessageBroker` |
| Controllers delegam para Use Cases | âš ï¸ | Remover controller.py legado |
| InjeÃ§Ã£o via `Depends` | âŒ | Implementar providers |
| ExceÃ§Ãµes de domÃ­nio prÃ³prias | âŒ | Criar mÃ³dulo `domain/exceptions.py` |
| Testabilidade dos Use Cases | âš ï¸ | ApÃ³s criar interfaces |

---

**ConclusÃ£o:** A arquitetura estÃ¡ 70% aderente Ã  Clean Architecture. As principais melhorias sÃ£o: (1) abstrair `send_to_queue` via interface, (2) remover duplicaÃ§Ã£o `analyze`/`report`, e (3) usar `Depends` para injeÃ§Ã£o nos controllers.